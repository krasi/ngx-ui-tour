import { inject, Injectable, RendererFactory2 } from '@angular/core';
import { ScrollingService } from './scrolling.service';
import { TourResizeObserverService } from './tour-resize-observer.service';
import { DOCUMENT } from '@angular/common';
import { OverflowUtils, ScrollUtils } from './utils';
import * as i0 from "@angular/core";
export class TourBackdropService {
    constructor() {
        this.isSpotlightClosed = false;
        this.rendererFactory = inject(RendererFactory2);
        this.renderer = this.rendererFactory.createRenderer(null, null);
        this.resizeObserverService = inject(TourResizeObserverService);
        this.scrollingService = inject(ScrollingService);
        this.document = inject(DOCUMENT);
    }
    show(targetElement, step) {
        if (this.targetHtmlElement) {
            this.resizeObserverService.unobserveElement(this.targetHtmlElement);
        }
        this.targetHtmlElement = targetElement.nativeElement;
        this.step = step;
        this.resizeObserverService.observeElement(this.targetHtmlElement);
        if (!this.backdropElements) {
            this.backdropElements = this.createBackdropElements();
            this.subscribeToResizeEvents();
        }
        this.isSpotlightClosed = false;
        this.setBackdropPosition();
    }
    closeSpotlight() {
        if (!this.backdropElements) {
            return;
        }
        const targetRect = this.targetHtmlElement.getBoundingClientRect(), centerX = targetRect.left + (targetRect.width / 2), centerY = targetRect.top + (targetRect.height / 2), centerRect = {
            top: centerY,
            right: centerX,
            bottom: centerY,
            left: centerX,
            width: 0,
            height: 0
        };
        this.isSpotlightClosed = true;
        this.setBackdropPosition(centerRect);
    }
    setBackdropPosition(rectangle = null) {
        const docEl = this.document.documentElement, scrollContainer = ScrollUtils.getScrollContainer(this.targetHtmlElement, this.step.scrollContainer) ?? docEl, elementBoundingRect = rectangle ?? this.targetHtmlElement.getBoundingClientRect(), scrollContainerRect = scrollContainer.getBoundingClientRect(), visibleSection = OverflowUtils.getVisibleSection(elementBoundingRect, scrollContainerRect), scrollHeight = docEl.scrollHeight, scrollWidth = docEl.scrollWidth, window = this.document.defaultView, scrollX = window.scrollX, scrollY = window.scrollY, offset = this.isSpotlightClosed ? 0 : this.step.backdropConfig?.offset ?? 0, leftRect = {
            width: visibleSection.left + scrollX - offset,
            height: scrollHeight,
            top: 0,
            left: 0
        }, topRect = {
            width: visibleSection.width + offset * 2,
            height: visibleSection.top + scrollY - offset,
            top: 0,
            left: visibleSection.left + scrollX - offset
        }, bottomRect = {
            width: visibleSection.width + offset * 2,
            height: scrollHeight - (visibleSection.bottom + scrollY) - offset,
            top: visibleSection.bottom + scrollY + offset,
            left: visibleSection.left + scrollX - offset
        }, rightRect = {
            width: scrollWidth - (visibleSection.right + scrollX) - offset,
            height: scrollHeight,
            top: 0,
            left: visibleSection.right + scrollX + offset
        }, rectangles = [leftRect, topRect, bottomRect, rightRect];
        for (let i = 0; i < rectangles.length; i++) {
            const styles = this.createBackdropStyles(rectangles[i]);
            this.applyStyles(styles, this.backdropElements[i]);
        }
    }
    subscribeToResizeEvents() {
        this.resizeSubscription = this.resizeObserverService.resize$
            .subscribe(() => {
            this.setBackdropPosition();
            if (!this.step.disableScrollToAnchor) {
                this.scrollingService.ensureVisible(this.targetHtmlElement, {
                    center: this.step.centerAnchorOnScroll,
                    smoothScroll: false
                });
            }
        });
    }
    close() {
        if (this.backdropElements) {
            this.resizeObserverService.unobserveElement(this.targetHtmlElement);
            this.removeBackdropElement();
            this.resizeSubscription.unsubscribe();
        }
    }
    disconnectResizeObserver() {
        this.resizeObserverService.disconnect();
    }
    removeBackdropElement() {
        this.backdropElements.forEach(backdropElement => this.renderer.removeChild(this.parentContainer, backdropElement));
        this.backdropElements = undefined;
    }
    applyStyles(styles, element) {
        for (const name of Object.keys(styles)) {
            this.renderer.setStyle(element, name, styles[name]);
        }
    }
    createBackdropStyles(rectangle) {
        const config = this.step.backdropConfig, normalizedRect = {
            ...rectangle,
            width: Math.max(rectangle.width, 0),
            height: Math.max(rectangle.height, 0)
        };
        return {
            position: 'absolute',
            width: `${normalizedRect.width}px`,
            height: `${normalizedRect.height}px`,
            top: `${normalizedRect.top}px`,
            left: `${normalizedRect.left}px`,
            backgroundColor: config?.backgroundColor ?? 'rgba(0, 0, 0, 0.7)',
            zIndex: config?.zIndex ?? '101'
        };
    }
    createBackdropElement() {
        const backdropElement = this.renderer.createElement('div');
        this.renderer.addClass(backdropElement, 'ngx-ui-tour_backdrop');
        this.renderer.appendChild(this.parentContainer, backdropElement);
        return backdropElement;
    }
    createBackdropElements() {
        return Array
            .from({ length: 4 })
            .map(() => this.createBackdropElement());
    }
    get parentContainer() {
        const parent = this.step.backdropConfig?.parentContainer;
        if (parent instanceof HTMLElement) {
            return parent;
        }
        if (typeof parent === 'string') {
            const queryResult = this.document.documentElement.querySelector(parent);
            return queryResult ?? this.document.body;
        }
        return this.document.body;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.12", ngImport: i0, type: TourBackdropService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.12", ngImport: i0, type: TourBackdropService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.12", ngImport: i0, type: TourBackdropService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG91ci1iYWNrZHJvcC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LXVpLXRvdXItY29yZS9zcmMvbGliL3RvdXItYmFja2Ryb3Auc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWEsTUFBTSxFQUFFLFVBQVUsRUFBRSxnQkFBZ0IsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUUvRSxPQUFPLEVBQUMsZ0JBQWdCLEVBQUMsTUFBTSxxQkFBcUIsQ0FBQztBQUNyRCxPQUFPLEVBQUMseUJBQXlCLEVBQUMsTUFBTSxnQ0FBZ0MsQ0FBQztBQUV6RSxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFDLGFBQWEsRUFBRSxXQUFXLEVBQUMsTUFBTSxTQUFTLENBQUM7O0FBeUJuRCxNQUFNLE9BQU8sbUJBQW1CO0lBSGhDO1FBU1ksc0JBQWlCLEdBQUcsS0FBSyxDQUFDO1FBRWpCLG9CQUFlLEdBQUcsTUFBTSxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDM0MsYUFBUSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUMzRCwwQkFBcUIsR0FBRyxNQUFNLENBQUMseUJBQXlCLENBQUMsQ0FBQztRQUMxRCxxQkFBZ0IsR0FBRyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUM1QyxhQUFRLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0tBNktoRDtJQTNLVSxJQUFJLENBQUMsYUFBeUIsRUFBRSxJQUFpQjtRQUNwRCxJQUFJLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1lBQ3pCLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUN4RSxDQUFDO1FBRUQsSUFBSSxDQUFDLGlCQUFpQixH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QUFDLENBQUM7SUFDakQsQ0FBQztJQUVELElBQVksZUFBZTtRQUN2QixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxlQUFlLENBQUM7UUFFekQsSUFBSSxNQUFNLFlBQVksV0FBVyxFQUFFLENBQUM7WUFDaEMsT0FBTyxNQUFNLENBQUM7UUFDbEIsQ0FBQztRQUNELElBQUksT0FBTyxNQUFNLEtBQUssUUFBUSxFQUFFLENBQUM7WUFDN0IsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBZ0IsQ0FBQztZQUV2RixPQUFPLFdBQVcsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQztRQUM3QyxDQUFDO1FBRUQsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQztJQUM5QixDQUFDOytHQXZMUSxtQkFBbUI7bUhBQW5CLG1CQUFtQixjQUZoQixNQUFNOzs0RkFFVCxtQkFBbUI7a0JBSC9CLFVBQVU7bUJBQUM7b0JBQ1IsVUFBVSxFQUFFLE1BQU07aUJBQ3JCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtFbGVtZW50UmVmLCBpbmplY3QsIEluamVjdGFibGUsIFJlbmRlcmVyRmFjdG9yeTJ9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtTdWJzY3JpcHRpb259IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtTY3JvbGxpbmdTZXJ2aWNlfSBmcm9tICcuL3Njcm9sbGluZy5zZXJ2aWNlJztcbmltcG9ydCB7VG91clJlc2l6ZU9ic2VydmVyU2VydmljZX0gZnJvbSAnLi90b3VyLXJlc2l6ZS1vYnNlcnZlci5zZXJ2aWNlJztcbmltcG9ydCB7SVN0ZXBPcHRpb259IGZyb20gJy4vdG91ci5zZXJ2aWNlJztcbmltcG9ydCB7RE9DVU1FTlR9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQge092ZXJmbG93VXRpbHMsIFNjcm9sbFV0aWxzfSBmcm9tICcuL3V0aWxzJztcblxuaW50ZXJmYWNlIFJlY3RhbmdsZSB7XG4gICAgd2lkdGg6IG51bWJlcjtcbiAgICBoZWlnaHQ6IG51bWJlcjtcbiAgICB0b3A6IG51bWJlcjtcbiAgICBsZWZ0OiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQmFja2Ryb3BDb25maWcge1xuICAgIHpJbmRleD86IHN0cmluZztcbiAgICBiYWNrZ3JvdW5kQ29sb3I/OiBzdHJpbmc7XG4gICAgLyoqXG4gICAgICogUGFyZW50IGNvbnRhaW5lciBDU1Mgc2VsZWN0b3Igb3IgaHRtbCBlbGVtZW50IHJlZmVyZW5jZS4gU2V0IHRvIGZpeCBiYWNrZHJvcCBzdGFja2luZyBpc3N1ZXMuIERlZmF1bHRzIHRvIGJvZHkuXG4gICAgICovXG4gICAgcGFyZW50Q29udGFpbmVyPzogc3RyaW5nIHwgSFRNTEVsZW1lbnQ7XG4gICAgLyoqXG4gICAgICogT2Zmc2V0IGluIHBpeGVscyB0byBhZGQgc3BhY2UgYmV0d2VlbiB0aGUgYmFja2Ryb3AgYW5kIHRoZSBhbmNob3IgZWxlbWVudC5cbiAgICAgKi9cbiAgICBvZmZzZXQ/OiBudW1iZXI7XG59XG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgVG91ckJhY2tkcm9wU2VydmljZSB7XG5cbiAgICBwcml2YXRlIGJhY2tkcm9wRWxlbWVudHM6IEhUTUxFbGVtZW50W107XG4gICAgcHJpdmF0ZSB0YXJnZXRIdG1sRWxlbWVudDogSFRNTEVsZW1lbnQ7XG4gICAgcHJpdmF0ZSBzdGVwOiBJU3RlcE9wdGlvbjtcbiAgICBwcml2YXRlIHJlc2l6ZVN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuICAgIHByaXZhdGUgaXNTcG90bGlnaHRDbG9zZWQgPSBmYWxzZTtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgcmVuZGVyZXJGYWN0b3J5ID0gaW5qZWN0KFJlbmRlcmVyRmFjdG9yeTIpO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgcmVuZGVyZXIgPSB0aGlzLnJlbmRlcmVyRmFjdG9yeS5jcmVhdGVSZW5kZXJlcihudWxsLCBudWxsKTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHJlc2l6ZU9ic2VydmVyU2VydmljZSA9IGluamVjdChUb3VyUmVzaXplT2JzZXJ2ZXJTZXJ2aWNlKTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNjcm9sbGluZ1NlcnZpY2UgPSBpbmplY3QoU2Nyb2xsaW5nU2VydmljZSk7XG4gICAgcHJpdmF0ZSByZWFkb25seSBkb2N1bWVudCA9IGluamVjdChET0NVTUVOVCk7XG5cbiAgICBwdWJsaWMgc2hvdyh0YXJnZXRFbGVtZW50OiBFbGVtZW50UmVmLCBzdGVwOiBJU3RlcE9wdGlvbikge1xuICAgICAgICBpZiAodGhpcy50YXJnZXRIdG1sRWxlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5yZXNpemVPYnNlcnZlclNlcnZpY2UudW5vYnNlcnZlRWxlbWVudCh0aGlzLnRhcmdldEh0bWxFbGVtZW50KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMudGFyZ2V0SHRtbEVsZW1lbnQgPSB0YXJnZXRFbGVtZW50Lm5hdGl2ZUVsZW1lbnQ7XG4gICAgICAgIHRoaXMuc3RlcCA9IHN0ZXA7XG5cbiAgICAgICAgdGhpcy5yZXNpemVPYnNlcnZlclNlcnZpY2Uub2JzZXJ2ZUVsZW1lbnQodGhpcy50YXJnZXRIdG1sRWxlbWVudCk7XG5cbiAgICAgICAgaWYgKCF0aGlzLmJhY2tkcm9wRWxlbWVudHMpIHtcbiAgICAgICAgICAgIHRoaXMuYmFja2Ryb3BFbGVtZW50cyA9IHRoaXMuY3JlYXRlQmFja2Ryb3BFbGVtZW50cygpO1xuICAgICAgICAgICAgdGhpcy5zdWJzY3JpYmVUb1Jlc2l6ZUV2ZW50cygpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5pc1Nwb3RsaWdodENsb3NlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLnNldEJhY2tkcm9wUG9zaXRpb24oKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY2xvc2VTcG90bGlnaHQoKSB7XG4gICAgICAgIGlmICghdGhpcy5iYWNrZHJvcEVsZW1lbnRzKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB0YXJnZXRSZWN0ID0gdGhpcy50YXJnZXRIdG1sRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSxcbiAgICAgICAgICAgIGNlbnRlclggPSB0YXJnZXRSZWN0LmxlZnQgKyAodGFyZ2V0UmVjdC53aWR0aCAvIDIpLFxuICAgICAgICAgICAgY2VudGVyWSA9IHRhcmdldFJlY3QudG9wICsgKHRhcmdldFJlY3QuaGVpZ2h0IC8gMiksXG4gICAgICAgICAgICBjZW50ZXJSZWN0ID0ge1xuICAgICAgICAgICAgICAgIHRvcDogY2VudGVyWSxcbiAgICAgICAgICAgICAgICByaWdodDogY2VudGVyWCxcbiAgICAgICAgICAgICAgICBib3R0b206IGNlbnRlclksXG4gICAgICAgICAgICAgICAgbGVmdDogY2VudGVyWCxcbiAgICAgICAgICAgICAgICB3aWR0aDogMCxcbiAgICAgICAgICAgICAgICBoZWlnaHQ6IDBcbiAgICAgICAgICAgIH0gYXMgRE9NUmVjdDtcblxuICAgICAgICB0aGlzLmlzU3BvdGxpZ2h0Q2xvc2VkID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5zZXRCYWNrZHJvcFBvc2l0aW9uKGNlbnRlclJlY3QpO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2V0QmFja2Ryb3BQb3NpdGlvbihyZWN0YW5nbGU6IERPTVJlY3QgPSBudWxsKSB7XG4gICAgICAgIGNvbnN0IGRvY0VsID0gdGhpcy5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsXG4gICAgICAgICAgICBzY3JvbGxDb250YWluZXIgPSBTY3JvbGxVdGlscy5nZXRTY3JvbGxDb250YWluZXIodGhpcy50YXJnZXRIdG1sRWxlbWVudCwgdGhpcy5zdGVwLnNjcm9sbENvbnRhaW5lcikgPz8gZG9jRWwsXG4gICAgICAgICAgICBlbGVtZW50Qm91bmRpbmdSZWN0ID0gcmVjdGFuZ2xlID8/IHRoaXMudGFyZ2V0SHRtbEVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCksXG4gICAgICAgICAgICBzY3JvbGxDb250YWluZXJSZWN0ID0gc2Nyb2xsQ29udGFpbmVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLFxuICAgICAgICAgICAgdmlzaWJsZVNlY3Rpb24gPSBPdmVyZmxvd1V0aWxzLmdldFZpc2libGVTZWN0aW9uKGVsZW1lbnRCb3VuZGluZ1JlY3QsIHNjcm9sbENvbnRhaW5lclJlY3QpLFxuICAgICAgICAgICAgc2Nyb2xsSGVpZ2h0ID0gZG9jRWwuc2Nyb2xsSGVpZ2h0LFxuICAgICAgICAgICAgc2Nyb2xsV2lkdGggPSBkb2NFbC5zY3JvbGxXaWR0aCxcbiAgICAgICAgICAgIHdpbmRvdyA9IHRoaXMuZG9jdW1lbnQuZGVmYXVsdFZpZXcsXG4gICAgICAgICAgICBzY3JvbGxYID0gd2luZG93LnNjcm9sbFgsXG4gICAgICAgICAgICBzY3JvbGxZID0gd2luZG93LnNjcm9sbFksXG4gICAgICAgICAgICBvZmZzZXQgPSB0aGlzLmlzU3BvdGxpZ2h0Q2xvc2VkID8gMCA6IHRoaXMuc3RlcC5iYWNrZHJvcENvbmZpZz8ub2Zmc2V0ID8/IDAsXG4gICAgICAgICAgICBsZWZ0UmVjdDogUmVjdGFuZ2xlID0ge1xuICAgICAgICAgICAgICAgIHdpZHRoOiB2aXNpYmxlU2VjdGlvbi5sZWZ0ICsgc2Nyb2xsWCAtIG9mZnNldCxcbiAgICAgICAgICAgICAgICBoZWlnaHQ6IHNjcm9sbEhlaWdodCxcbiAgICAgICAgICAgICAgICB0b3A6IDAsXG4gICAgICAgICAgICAgICAgbGVmdDogMFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHRvcFJlY3Q6IFJlY3RhbmdsZSA9IHtcbiAgICAgICAgICAgICAgICB3aWR0aDogdmlzaWJsZVNlY3Rpb24ud2lkdGggKyBvZmZzZXQgKiAyLFxuICAgICAgICAgICAgICAgIGhlaWdodDogdmlzaWJsZVNlY3Rpb24udG9wICsgc2Nyb2xsWSAtIG9mZnNldCxcbiAgICAgICAgICAgICAgICB0b3A6IDAsXG4gICAgICAgICAgICAgICAgbGVmdDogdmlzaWJsZVNlY3Rpb24ubGVmdCArIHNjcm9sbFggLSBvZmZzZXRcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBib3R0b21SZWN0OiBSZWN0YW5nbGUgPSB7XG4gICAgICAgICAgICAgICAgd2lkdGg6IHZpc2libGVTZWN0aW9uLndpZHRoICsgb2Zmc2V0ICogMixcbiAgICAgICAgICAgICAgICBoZWlnaHQ6IHNjcm9sbEhlaWdodCAtICh2aXNpYmxlU2VjdGlvbi5ib3R0b20gKyBzY3JvbGxZKSAtIG9mZnNldCxcbiAgICAgICAgICAgICAgICB0b3A6IHZpc2libGVTZWN0aW9uLmJvdHRvbSArIHNjcm9sbFkgKyBvZmZzZXQsXG4gICAgICAgICAgICAgICAgbGVmdDogdmlzaWJsZVNlY3Rpb24ubGVmdCArIHNjcm9sbFggLSBvZmZzZXRcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICByaWdodFJlY3Q6IFJlY3RhbmdsZSA9IHtcbiAgICAgICAgICAgICAgICB3aWR0aDogc2Nyb2xsV2lkdGggLSAodmlzaWJsZVNlY3Rpb24ucmlnaHQgKyBzY3JvbGxYKSAtIG9mZnNldCxcbiAgICAgICAgICAgICAgICBoZWlnaHQ6IHNjcm9sbEhlaWdodCxcbiAgICAgICAgICAgICAgICB0b3A6IDAsXG4gICAgICAgICAgICAgICAgbGVmdDogdmlzaWJsZVNlY3Rpb24ucmlnaHQgKyBzY3JvbGxYICsgb2Zmc2V0XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcmVjdGFuZ2xlczogUmVjdGFuZ2xlW10gPSBbbGVmdFJlY3QsIHRvcFJlY3QsIGJvdHRvbVJlY3QsIHJpZ2h0UmVjdF07XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZWN0YW5nbGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBjb25zdCBzdHlsZXMgPSB0aGlzLmNyZWF0ZUJhY2tkcm9wU3R5bGVzKHJlY3RhbmdsZXNbaV0pO1xuICAgICAgICAgICAgdGhpcy5hcHBseVN0eWxlcyhzdHlsZXMsIHRoaXMuYmFja2Ryb3BFbGVtZW50c1tpXSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHN1YnNjcmliZVRvUmVzaXplRXZlbnRzKCkge1xuICAgICAgICB0aGlzLnJlc2l6ZVN1YnNjcmlwdGlvbiA9IHRoaXMucmVzaXplT2JzZXJ2ZXJTZXJ2aWNlLnJlc2l6ZSRcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEJhY2tkcm9wUG9zaXRpb24oKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLnN0ZXAuZGlzYWJsZVNjcm9sbFRvQW5jaG9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbGluZ1NlcnZpY2UuZW5zdXJlVmlzaWJsZSh0aGlzLnRhcmdldEh0bWxFbGVtZW50LCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2VudGVyOiB0aGlzLnN0ZXAuY2VudGVyQW5jaG9yT25TY3JvbGwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc21vb3RoU2Nyb2xsOiBmYWxzZVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIHB1YmxpYyBjbG9zZSgpIHtcbiAgICAgICAgaWYgKHRoaXMuYmFja2Ryb3BFbGVtZW50cykge1xuICAgICAgICAgICAgdGhpcy5yZXNpemVPYnNlcnZlclNlcnZpY2UudW5vYnNlcnZlRWxlbWVudCh0aGlzLnRhcmdldEh0bWxFbGVtZW50KTtcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlQmFja2Ryb3BFbGVtZW50KCk7XG4gICAgICAgICAgICB0aGlzLnJlc2l6ZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGRpc2Nvbm5lY3RSZXNpemVPYnNlcnZlcigpIHtcbiAgICAgICAgdGhpcy5yZXNpemVPYnNlcnZlclNlcnZpY2UuZGlzY29ubmVjdCgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVtb3ZlQmFja2Ryb3BFbGVtZW50KCkge1xuICAgICAgICB0aGlzLmJhY2tkcm9wRWxlbWVudHMuZm9yRWFjaChcbiAgICAgICAgICAgIGJhY2tkcm9wRWxlbWVudCA9PiB0aGlzLnJlbmRlcmVyLnJlbW92ZUNoaWxkKHRoaXMucGFyZW50Q29udGFpbmVyLCBiYWNrZHJvcEVsZW1lbnQpXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMuYmFja2Ryb3BFbGVtZW50cyA9IHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFwcGx5U3R5bGVzKHN0eWxlczogUGFydGlhbDxDU1NTdHlsZURlY2xhcmF0aW9uPiwgZWxlbWVudDogSFRNTEVsZW1lbnQpIHtcbiAgICAgICAgZm9yIChjb25zdCBuYW1lIG9mIE9iamVjdC5rZXlzKHN0eWxlcykpIHtcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuc2V0U3R5bGUoZWxlbWVudCwgbmFtZSwgc3R5bGVzW25hbWUgYXMga2V5b2YgQ1NTU3R5bGVEZWNsYXJhdGlvbl0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVCYWNrZHJvcFN0eWxlcyhyZWN0YW5nbGU6IFJlY3RhbmdsZSkge1xuICAgICAgICBjb25zdCBjb25maWcgPSB0aGlzLnN0ZXAuYmFja2Ryb3BDb25maWcsXG4gICAgICAgICAgICBub3JtYWxpemVkUmVjdCA9IHtcbiAgICAgICAgICAgICAgICAuLi5yZWN0YW5nbGUsXG4gICAgICAgICAgICAgICAgd2lkdGg6IE1hdGgubWF4KHJlY3RhbmdsZS53aWR0aCwgMCksXG4gICAgICAgICAgICAgICAgaGVpZ2h0OiBNYXRoLm1heChyZWN0YW5nbGUuaGVpZ2h0LCAwKVxuICAgICAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgcG9zaXRpb246ICdhYnNvbHV0ZScsXG4gICAgICAgICAgICB3aWR0aDogYCR7bm9ybWFsaXplZFJlY3Qud2lkdGh9cHhgLFxuICAgICAgICAgICAgaGVpZ2h0OiBgJHtub3JtYWxpemVkUmVjdC5oZWlnaHR9cHhgLFxuICAgICAgICAgICAgdG9wOiBgJHtub3JtYWxpemVkUmVjdC50b3B9cHhgLFxuICAgICAgICAgICAgbGVmdDogYCR7bm9ybWFsaXplZFJlY3QubGVmdH1weGAsXG4gICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IGNvbmZpZz8uYmFja2dyb3VuZENvbG9yID8/ICdyZ2JhKDAsIDAsIDAsIDAuNyknLFxuICAgICAgICAgICAgekluZGV4OiBjb25maWc/LnpJbmRleCA/PyAnMTAxJ1xuICAgICAgICB9IGFzIFBhcnRpYWw8Q1NTU3R5bGVEZWNsYXJhdGlvbj47XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVCYWNrZHJvcEVsZW1lbnQoKSB7XG4gICAgICAgIGNvbnN0IGJhY2tkcm9wRWxlbWVudCA9IHRoaXMucmVuZGVyZXIuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3MoYmFja2Ryb3BFbGVtZW50LCAnbmd4LXVpLXRvdXJfYmFja2Ryb3AnKTtcbiAgICAgICAgdGhpcy5yZW5kZXJlci5hcHBlbmRDaGlsZCh0aGlzLnBhcmVudENvbnRhaW5lciwgYmFja2Ryb3BFbGVtZW50KTtcbiAgICAgICAgcmV0dXJuIGJhY2tkcm9wRWxlbWVudDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZUJhY2tkcm9wRWxlbWVudHMoKSB7XG4gICAgICAgIHJldHVybiBBcnJheVxuICAgICAgICAgICAgLmZyb20oe2xlbmd0aDogNH0pXG4gICAgICAgICAgICAubWFwKCgpID0+IHRoaXMuY3JlYXRlQmFja2Ryb3BFbGVtZW50KCkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0IHBhcmVudENvbnRhaW5lcigpOiBIVE1MRWxlbWVudCB7XG4gICAgICAgIGNvbnN0IHBhcmVudCA9IHRoaXMuc3RlcC5iYWNrZHJvcENvbmZpZz8ucGFyZW50Q29udGFpbmVyO1xuXG4gICAgICAgIGlmIChwYXJlbnQgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkge1xuICAgICAgICAgICAgcmV0dXJuIHBhcmVudDtcbiAgICAgICAgfVxuICAgICAgICBpZiAodHlwZW9mIHBhcmVudCA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIGNvbnN0IHF1ZXJ5UmVzdWx0ID0gdGhpcy5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQucXVlcnlTZWxlY3RvcihwYXJlbnQpIGFzIEhUTUxFbGVtZW50O1xuXG4gICAgICAgICAgICByZXR1cm4gcXVlcnlSZXN1bHQgPz8gdGhpcy5kb2N1bWVudC5ib2R5O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZG9jdW1lbnQuYm9keTtcbiAgICB9XG5cbn1cbiJdfQ==